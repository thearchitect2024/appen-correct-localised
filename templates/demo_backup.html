<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppenCorrect Demo - Spelling & Grammar Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .demo-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .demo-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

                 .input-panel, .output-panel {
             background: #f8f9fa;
             border-radius: 15px;
             padding: 30px;
         }

         .input-panel {
             position: relative; /* Required for absolute positioning of bubble */
         }

        .panel-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

                           .text-container {
              position: relative;
              width: 100%;
          }

                     .text-input {
               width: 100%;
               height: 200px;
               border: 2px solid #e9ecef;
               border-radius: 10px;
               padding: 15px;
               font-size: 16px;
               font-family: inherit;
               resize: vertical;
               transition: border-color 0.3s;
               background: rgba(255, 255, 255, 0.9);
               position: relative;
               z-index: 2;
           }

          .text-input:focus {
              outline: none;
              border-color: #667eea;
          }

          .text-input.checking {
              border-color: #ffc107;
              background: #fffbf0;
          }

          .text-input.has-errors {
              border-color: #dc3545;
          }

          .text-input.no-errors {
              border-color: #28a745;
          }

                                           .text-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 200px;
                border: 2px solid transparent;
                border-radius: 10px;
                padding: 15px;
                font-size: 16px;
                font-family: inherit;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow: hidden;
                pointer-events: none;
                z-index: 3;
                line-height: 1.4;
                background: transparent;
            }

                                           .error-highlight {
                background-color: rgba(255, 0, 0, 0.2) !important;
                border-bottom: 2px wavy #ff4444 !important;
                cursor: pointer;
                position: relative;
                pointer-events: all;
                color: #000 !important;
                display: inline;
                z-index: 4;
            }

                     .error-highlight:hover {
               background-color: rgba(255, 0, 0, 0.3);
           }

           /* Disable Grammarly and other extensions */
           .text-input {
               -webkit-user-modify: read-write-plaintext-only;
           }

           /* Hide Grammarly overlay */
           grammarly-extension,
           grammarly-mirror,
           [data-grammarly-part] {
               display: none !important;
           }

        .options-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .checkbox-group label {
            font-size: 16px;
            cursor: pointer;
        }

        .correct-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .correct-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .correct-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        

        .results {
            margin-top: 20px;
        }

        .result-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .correction {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .original {
            background: #ffebee;
            color: #c62828;
            padding: 4px 8px;
            border-radius: 5px;
            text-decoration: line-through;
        }

        .suggestion {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 5px;
            font-weight: 600;
        }

        .type-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: 600;
        }

        .type-spelling {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-grammar {
            background: #fff3e0;
            color: #f57c00;
        }

        .type-style {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .confidence {
            font-size: 12px;
            color: #666;
        }

        .processed-text {
            background: white;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-size: 16px;
            line-height: 1.6;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .examples {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .example-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .example-btn {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .example-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .example-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .example-text {
            font-size: 14px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .mode-option {
            position: relative;
        }

        .mode-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .mode-label {
            display: block;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
        }

        .mode-label:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .mode-option input[type="radio"]:checked + .mode-label {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .mode-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .mode-desc {
            font-size: 13px;
            opacity: 0.8;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .mode-time {
            font-size: 12px;
            opacity: 0.7;
            font-style: italic;
        }

                 .mode-option input[type="radio"]:checked + .mode-label .mode-desc,
         .mode-option input[type="radio"]:checked + .mode-label .mode-time {
             opacity: 0.9;
         }

         .status-indicator {
             display: flex;
             align-items: center;
             gap: 8px;
             font-size: 14px;
             margin-top: 10px;
             padding: 8px 12px;
             border-radius: 6px;
             transition: all 0.3s;
         }

         .status-checking {
             background: #fff3cd;
             color: #856404;
             border: 1px solid #ffeaa7;
         }

         .status-errors {
             background: #f8d7da;
             color: #721c24;
             border: 1px solid #f5c6cb;
         }

         .status-clean {
             background: #d1edff;
             color: #0c5460;
             border: 1px solid #b8daff;
         }

         .status-ready {
             background: #f8f9fa;
             color: #6c757d;
             border: 1px solid #e9ecef;
         }

         .inline-corrections {
             margin-top: 15px;
             max-height: 200px;
             overflow-y: auto;
         }

         .correction-item {
             background: white;
             border: 1px solid #e9ecef;
             border-radius: 8px;
             padding: 12px;
             margin-bottom: 8px;
             cursor: pointer;
             transition: all 0.2s;
         }

         .correction-item:hover {
             border-color: #667eea;
             transform: translateY(-1px);
             box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
         }

         .correction-preview {
             display: flex;
             align-items: center;
             gap: 8px;
             margin-bottom: 6px;
         }

                   .correction-type {
              font-size: 11px;
              padding: 2px 6px;
              border-radius: 10px;
              font-weight: 600;
              text-transform: uppercase;
          }

                     /* Correction Bubble Styles */
           .correction-bubble {
               position: absolute;
               background: white;
               border: 2px solid #667eea;
               border-radius: 8px;
               box-shadow: 0 8px 20px rgba(0,0,0,0.25);
               padding: 12px;
               min-width: 250px;
               max-width: 350px;
               z-index: 9999;
               display: none;
               font-size: 14px;
               font-family: inherit;
           }

          .correction-bubble::before {
              content: '';
              position: absolute;
              top: -8px;
              left: 20px;
              width: 0;
              height: 0;
              border-left: 8px solid transparent;
              border-right: 8px solid transparent;
              border-bottom: 8px solid white;
          }

          .correction-bubble::after {
              content: '';
              position: absolute;
              top: -9px;
              left: 20px;
              width: 0;
              height: 0;
              border-left: 8px solid transparent;
              border-right: 8px solid transparent;
              border-bottom: 8px solid #e0e0e0;
              z-index: -1;
          }

          .bubble-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 8px;
              padding-bottom: 8px;
              border-bottom: 1px solid #f0f0f0;
          }

          .bubble-type {
              font-size: 10px;
              padding: 2px 6px;
              border-radius: 10px;
              font-weight: 600;
              text-transform: uppercase;
              background: #e3f2fd;
              color: #1976d2;
          }

          .bubble-confidence {
              font-size: 11px;
              color: #666;
              font-weight: 500;
          }

          .bubble-correction {
              margin-bottom: 12px;
          }

          .bubble-original {
              background: #ffebee;
              color: #c62828;
              padding: 2px 6px;
              border-radius: 4px;
              text-decoration: line-through;
              font-weight: 500;
          }

          .bubble-arrow {
              margin: 0 8px;
              color: #666;
          }

          .bubble-suggestion {
              background: #e8f5e8;
              color: #2e7d32;
              padding: 2px 6px;
              border-radius: 4px;
              font-weight: 600;
              cursor: pointer;
          }

          .bubble-suggestion:hover {
              background: #c8e6c9;
          }

          .bubble-actions {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-top: 8px;
              padding-top: 8px;
              border-top: 1px solid #f0f0f0;
          }

          .bubble-feedback {
              display: flex;
              gap: 8px;
          }

          .feedback-btn {
              background: none;
              border: 1px solid #e0e0e0;
              border-radius: 4px;
              padding: 4px 6px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              width: 28px;
              height: 28px;
              transition: all 0.2s;
              font-size: 12px;
          }

          .feedback-btn:hover {
              background: #f5f5f5;
              border-color: #ccc;
          }

          .feedback-btn.thumbs-up:hover {
              background: #e8f5e8;
              border-color: #4caf50;
              color: #4caf50;
          }

          .feedback-btn.thumbs-down:hover {
              background: #ffebee;
              border-color: #f44336;
              color: #f44336;
          }

          .feedback-btn.delete:hover {
              background: #fff3e0;
              border-color: #ff9800;
              color: #ff9800;
          }

          /* Modal Styles */
          .modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.5);
              display: none;
              justify-content: center;
              align-items: center;
              z-index: 2000;
          }

          .modal {
              background: white;
              border-radius: 12px;
              padding: 24px;
              width: 90%;
              max-width: 500px;
              box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          }

          .modal-header {
              font-size: 18px;
              font-weight: 600;
              margin-bottom: 16px;
              color: #333;
          }

          .modal-body {
              margin-bottom: 20px;
          }

          .modal-input {
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 14px;
              margin-top: 8px;
              font-family: inherit;
          }

          .modal-input:focus {
              outline: none;
              border-color: #667eea;
          }

          .modal-actions {
              display: flex;
              gap: 12px;
              justify-content: flex-end;
          }

          .modal-btn {
              padding: 10px 20px;
              border: none;
              border-radius: 6px;
              font-size: 14px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.2s;
          }

          .modal-btn.primary {
              background: #667eea;
              color: white;
          }

          .modal-btn.primary:hover {
              background: #5a6fd8;
          }

          .modal-btn.secondary {
              background: #f5f5f5;
              color: #666;
              border: 1px solid #e0e0e0;
          }

          .modal-btn.secondary:hover {
              background: #e8e8e8;
          }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AppenCorrect</h1>
            <p>AI-Powered Spelling & Grammar Checker with Language Detection</p>
        </div>

        <div class="main-content">
            <!-- Example Texts -->
            <div class="examples">
                <div class="panel-title">📝 Example Texts (Click to Load)</div>
                <div class="example-buttons">
                    <div class="example-btn" onclick="loadExample('spelling')">
                        <div class="example-title">Spelling Errors</div>
                        <div class="example-text">This sentance has speling erors that need fixing...</div>
                    </div>
                    <div class="example-btn" onclick="loadExample('grammar')">
                        <div class="example-title">Grammar Issues</div>
                        <div class="example-text">This are a test of grammar checking capabilities...</div>
                    </div>
                    <div class="example-btn" onclick="loadExample('mixed')">
                        <div class="example-title">Mixed Problems</div>
                        <div class="example-text">The resturant manager, who has been working their for...</div>
                    </div>
                    <div class="example-btn" onclick="loadExample('complex')">
                        <div class="example-title">Complex Text</div>
                        <div class="example-text">Artificial inteligence is revolutionizing how we aproach...</div>
                    </div>
                                         <div class="example-btn" onclick="loadExample('homophones')">
                         <div class="example-title">🤖 Real-Time Demo</div>
                         <div class="example-text">Your going to loose you're job if you effected the...</div>
                     </div>
                </div>
            </div>

                         <!-- Options Panel -->
             <div class="options-panel">
                 <div class="panel-title">🤖 Real-Time AI Grammar Checking</div>
                 
                 <!-- AI-First Mode Info -->
                 <div style="margin-bottom: 25px;">
                     <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 20px; text-align: center;">
                         <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">🤖 AI-Powered Grammar Correction</div>
                         <div style="opacity: 0.9; margin-bottom: 8px;">Intelligent text analysis that automatically detects language and applies specialized grammar rules for English and French. Just start typing and corrections appear instantly!</div>
                         <div style="font-size: 14px; opacity: 0.8; margin-bottom: 12px;">Powered by Gemini 2.5 Flash</div>
                         
                         <!-- Performance Metrics -->
                         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 12px; font-size: 13px;">
                             <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 8px;">
                                 <div style="font-weight: 600;">💰 Cost</div>
                                 <div style="opacity: 0.9;">$0.0001/sentence</div>
                                 <div style="opacity: 0.7; font-size: 11px;">$10 per 100k</div>
                             </div>
                             <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 8px;">
                                 <div style="font-weight: 600;">⚡ Speed</div>
                                 <div style="opacity: 0.9;">0.80s avg</div>
                                 <div style="opacity: 0.7; font-size: 11px;">per API call</div>
                             </div>
                             <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 8px;">
                                 <div style="font-weight: 600;">🎯 Accuracy</div>
                                 <div style="opacity: 0.9;">EN: 97.13%</div>
                                 <div style="opacity: 0.7; font-size: 11px;">FR: 96.08%</div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>

            <!-- Main Demo Section -->
            <div class="demo-section">
                                                  <div class="input-panel">
                      <div class="panel-title">📝 Input Text</div>
                      
                      <div class="text-container">
                          <div class="text-overlay" id="textOverlay"></div>
                                                     <textarea 
                               class="text-input" 
                               id="inputText" 
                               placeholder="Start typing and watch AI correct your text in real-time..."
                               data-gramm="false"
                               data-gramm_editor="false"
                               data-enable-grammarly="false"
                               spellcheck="false"
                               autocomplete="off"
                               autocorrect="off"
                               autocapitalize="off"
                           ></textarea>
                      </div>
                      
                                             <!-- Status Indicator -->
                       <div class="status-indicator status-ready" id="statusIndicator">
                           <span id="statusIcon">✏️</span>
                           <span id="statusText">Ready to check your text</span>
                       </div>
                       
                       <!-- Debug button -->
                       <button onclick="testBubble()" style="margin-top: 10px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 5px;">Test Bubble</button>
                  </div>

                <div class="output-panel">
                    <div class="panel-title">✨ Corrected Text</div>
                    <div id="processedText" style="min-height: 200px; display: flex; align-items: center; justify-content: center; color: #999;">
                        Corrected text will appear here...
                    </div>
                </div>
            </div>

            
        </div>
    </div>

    <script>
        const examples = {
            spelling: "This sentance has many speling erors that need to be corected. The dificulty lies in identifing all the misstakes automaticaly.",
            grammar: "This are a test of grammar checking capabilities. I are going to the store tomorrow. She have been working here for many years.",
            mixed: "The resturant manager, who has been working their for over five years, decided to reorganize the menu because alot of costumers have been complaining about the food quality and the slow service, and he beleives that this changes will help improve there overall dining experiance.",
            complex: "Artificial inteligence is revolutionizing how we aproach language procesing and error corection. Machine learning algoritms can now identifiy contextual mistakes that traditional spell checkers would miss, making them invalueable tools for writters and editors who want to ensure there work meets the highest standards of clarity and profesionalism.",
            homophones: "Your going to loose you're job if you effected the weather forecast. Their house is located wear the capitol building stands, and its important to no the difference between there, their, and they're. The companie's profits has been effected by the new regulations, so there considering a merger with there competitors."
        };

                          // Real-time checking variables
          let checkingTimeout;
          let isChecking = false;
          let lastCheckedText = '';
          let currentCorrections = [];
          let currentBubbleCorrection = null;

          function loadExample(type) {
              const inputText = document.getElementById('inputText');
              inputText.value = examples[type];
              updateTextOverlay();
              handleTextChange();
          }

          // Debounced text checking function
          function handleTextChange() {
              const inputText = document.getElementById('inputText');
              const currentText = inputText.value.trim();
              
              updateTextOverlay();
              clearTimeout(checkingTimeout);
              hideBubble();
              
              if (currentText.length < 5 || currentText === lastCheckedText) {
                  if (currentText.length === 0) {
                      updateStatus('ready', '✏️', 'Ready to check your text');
                      clearTextStyling();
                      clearOverlayHighlights();
                  }
                  return;
              }
              
              updateStatus('checking', '🔄', 'Checking grammar...');
              inputText.classList.add('checking');
              
              checkingTimeout = setTimeout(() => {
                  checkTextRealtime(currentText);
              }, 1500);
          }

          // Update text overlay for highlighting
          function updateTextOverlay() {
              const inputText = document.getElementById('inputText');
              const overlay = document.getElementById('textOverlay');
              // DON'T duplicate text - only clear if no highlights
              if (!overlay.innerHTML.includes('error-highlight')) {
                  overlay.innerHTML = '';
              }
          }

          async function checkTextRealtime(text) {
              if (isChecking) return;
              
              isChecking = true;
              lastCheckedText = text;
              
              try {
                  const options = {
                      ai_first_mode: true
                  };

                  const response = await fetch('/check', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          text: text,
                          options: options
                      })
                  });

                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }

                  const data = await response.json();
                  handleRealtimeResults(data);

              } catch (error) {
                  console.error('Error:', error);
                  updateStatus('ready', '⚠️', 'Check failed - try again');
              } finally {
                  isChecking = false;
                  clearTextStyling();
              }
          }

                     // Handle real-time results
           function handleRealtimeResults(data) {
               console.log('Received API response:', data);
               currentCorrections = data.corrections || [];
               console.log('Current corrections:', currentCorrections);
               
               if (currentCorrections.length > 0) {
                   updateStatus('errors', '⚠️', `${currentCorrections.length} correction${currentCorrections.length > 1 ? 's' : ''} found`);
                   highlightErrors(currentCorrections);
                   document.getElementById('inputText').classList.add('has-errors');
               } else {
                   updateStatus('clean', '✅', 'Text looks great!');
                   clearOverlayHighlights();
                   document.getElementById('inputText').classList.add('no-errors');
               }
               
               // Update corrected text display
               const processedTextDiv = document.getElementById('processedText');
               processedTextDiv.innerHTML = `
                   <div class="processed-text">
                       ${data.processed_text || data.original_text}
                   </div>
               `;
           }

                                                                                       // Highlight errors in overlay
             function highlightErrors(corrections) {
                 const inputText = document.getElementById("inputText");
                 const overlay = document.getElementById("textOverlay");
                 const text = inputText.value;
                 
                 // Create overlay with only highlights visible
                 overlay.innerHTML = "";
                 
                 corrections.forEach((correction, index) => {
                     const pos = text.indexOf(correction.original);
                     if (pos !== -1) {
                         // Create highlight span positioned absolutely
                         const highlight = document.createElement("span");
                         highlight.className = "error-highlight";
                         highlight.textContent = correction.original;
                         highlight.onclick = (e) => showBubble(e, index);
                         overlay.appendChild(highlight);
                     }
                 });
                 
                 console.log("Overlay updated with highlights only");
             }

          // Clear overlay highlights
          function clearOverlayHighlights() {
              const overlay = document.getElementById('textOverlay');
              overlay.innerHTML = '';
          }

                                           // Show correction bubble
            function showBubble(event, correctionIndex) {
                event.stopPropagation();
                
                console.log('showBubble called with index:', correctionIndex, 'total corrections:', currentCorrections.length);
                
                const correction = currentCorrections[correctionIndex];
                if (!correction) {
                    console.log('No correction found at index', correctionIndex);
                    return;
                }
                
                console.log('Showing bubble for correction:', correction);
                currentBubbleCorrection = correction;
                
                const bubble = document.getElementById('correctionBubble');
                const bubbleType = document.getElementById('bubbleType');
                const bubbleConfidence = document.getElementById('bubbleConfidence');
                const bubbleOriginal = document.getElementById('bubbleOriginal');
                const bubbleSuggestion = document.getElementById('bubbleSuggestion');
                
                // Update bubble content
                bubbleType.textContent = correction.type.toUpperCase();
                bubbleType.className = `bubble-type type-${correction.type}`;
                bubbleConfidence.textContent = `${Math.round(correction.confidence * 100)}% confident`;
                bubbleOriginal.textContent = correction.original;
                bubbleSuggestion.textContent = correction.suggestion;
                
                // Position bubble using viewport coordinates
                const rect = event.target.getBoundingClientRect();
                const bubbleWidth = 300;
                
                let left = rect.left;
                let top = rect.bottom + 10;
                
                // Ensure bubble stays within viewport
                if (left + bubbleWidth > window.innerWidth) {
                    left = window.innerWidth - bubbleWidth - 20;
                }
                if (left < 10) left = 10;
                
                bubble.style.left = `${left}px`;
                bubble.style.top = `${top}px`;
                bubble.style.display = 'block';
                bubble.style.position = 'fixed';
                bubble.style.zIndex = '10000';
                
                console.log('Bubble positioned at:', left, top);
                
                // Hide bubble when clicking elsewhere
                setTimeout(() => {
                    document.addEventListener('click', hideBubbleOnClickOutside, { once: true });
                }, 100);
            }

          // Hide bubble
          function hideBubble() {
              document.getElementById('correctionBubble').style.display = 'none';
              currentBubbleCorrection = null;
          }

          function hideBubbleOnClickOutside(event) {
              const bubble = document.getElementById('correctionBubble');
              if (!bubble.contains(event.target)) {
                  hideBubble();
              }
          }

          // Apply correction from bubble
          function applyCorrectionFromBubble() {
              if (!currentBubbleCorrection) return;
              
              const inputText = document.getElementById('inputText');
              const currentText = inputText.value;
              const newText = currentText.replace(currentBubbleCorrection.original, currentBubbleCorrection.suggestion);
              
              inputText.value = newText;
              hideBubble();
              updateTextOverlay();
              handleTextChange();
          }

          // Submit feedback
          function submitFeedback(type) {
              if (!currentBubbleCorrection) return;
              
              if (type === 'positive') {
                  console.log('Positive feedback for:', currentBubbleCorrection);
                  hideBubble();
                  // Here you could send feedback to your analytics
              } else if (type === 'negative') {
                  // Open modal for user correction
                  openFeedbackModal();
              }
          }

          // Delete bubble (ignore correction)
          function deleteBubble() {
              if (!currentBubbleCorrection) return;
              
              // Remove this correction from the current corrections
              const index = currentCorrections.indexOf(currentBubbleCorrection);
              if (index > -1) {
                  currentCorrections.splice(index, 1);
                  highlightErrors(currentCorrections);
                  
                  // Update status
                  if (currentCorrections.length > 0) {
                      updateStatus('errors', '⚠️', `${currentCorrections.length} correction${currentCorrections.length > 1 ? 's' : ''} found`);
                  } else {
                      updateStatus('clean', '✅', 'Text looks great!');
                      clearOverlayHighlights();
                  }
              }
              
              hideBubble();
          }

          // Open feedback modal
          function openFeedbackModal() {
              if (!currentBubbleCorrection) return;
              
              document.getElementById('modalOriginal').textContent = currentBubbleCorrection.original;
              document.getElementById('modalSuggestion').textContent = currentBubbleCorrection.suggestion;
              document.getElementById('modalCorrection').value = '';
              document.getElementById('modalOverlay').style.display = 'flex';
              
              // Focus on input
              setTimeout(() => {
                  document.getElementById('modalCorrection').focus();
              }, 100);
          }

          // Close modal
          function closeModal() {
              document.getElementById('modalOverlay').style.display = 'none';
          }

          // Submit user correction
          function submitCorrection() {
              const userCorrection = document.getElementById('modalCorrection').value.trim();
              
              if (!userCorrection) {
                  alert('Please enter a correction');
                  return;
              }
              
              console.log('User feedback:', {
                  original: currentBubbleCorrection.original,
                  aiSuggestion: currentBubbleCorrection.suggestion,
                  userCorrection: userCorrection
              });
              
              // Here you could send this feedback to improve your AI model
              
              closeModal();
              hideBubble();
          }

          // Update status indicator
          function updateStatus(type, icon, text) {
              const statusIndicator = document.getElementById('statusIndicator');
              const statusIcon = document.getElementById('statusIcon');
              const statusText = document.getElementById('statusText');
              
              statusIndicator.className = 'status-indicator';
              statusIndicator.classList.add(`status-${type}`);
              
              statusIcon.textContent = icon;
              statusText.textContent = text;
          }

          // Clear text styling
          function clearTextStyling() {
              const inputText = document.getElementById('inputText');
              inputText.classList.remove('checking', 'has-errors', 'no-errors');
          }

          // Initialize real-time checking
          function initializeRealtimeChecking() {
              const inputText = document.getElementById('inputText');
              
              inputText.addEventListener('input', handleTextChange);
              inputText.addEventListener('paste', () => {
                  setTimeout(handleTextChange, 100);
              });
              
              inputText.addEventListener('scroll', () => {
                  const overlay = document.getElementById('textOverlay');
                  overlay.scrollTop = inputText.scrollTop;
              });
              
              // Close modal on Escape key
              document.addEventListener('keydown', (e) => {
                  if (e.key === 'Escape') {
                      closeModal();
                      hideBubble();
                  }
              });
          }

                   // Test bubble function
          function testBubble() {
              console.log('Testing bubble...');
              const bubble = document.getElementById('correctionBubble');
              
              // Update bubble content with test data
              document.getElementById('bubbleType').textContent = 'GRAMMAR';
              document.getElementById('bubbleConfidence').textContent = '95% confident';
              document.getElementById('bubbleOriginal').textContent = 'test error';
              document.getElementById('bubbleSuggestion').textContent = 'test correction';
              
              // Position bubble in center of screen
              bubble.style.left = '50%';
              bubble.style.top = '50%';
              bubble.style.transform = 'translate(-50%, -50%)';
              bubble.style.display = 'block';
              bubble.style.position = 'fixed';
              bubble.style.zIndex = '10000';
              
              console.log('Bubble should be visible now');
              
              // Hide after 3 seconds
              setTimeout(() => {
                  hideBubble();
              }, 3000);
          }

          // Load a default example on page load
          window.onload = function() {
              initializeRealtimeChecking();
              loadExample('mixed');
          };
    </script>

    <!-- Correction Bubble -->
    <div class="correction-bubble" id="correctionBubble">
        <div class="bubble-header">
            <span class="bubble-type" id="bubbleType">GRAMMAR</span>
            <span class="bubble-confidence" id="bubbleConfidence">95% confident</span>
        </div>
        <div class="bubble-correction">
            <span class="bubble-original" id="bubbleOriginal">original</span>
            <span class="bubble-arrow">→</span>
            <span class="bubble-suggestion" id="bubbleSuggestion" onclick="applyCorrectionFromBubble()">suggestion</span>
        </div>
        <div class="bubble-actions">
            <div class="bubble-feedback">
                <button class="feedback-btn thumbs-up" onclick="submitFeedback('positive')" title="Good suggestion">
                    👍
                </button>
                <button class="feedback-btn thumbs-down" onclick="submitFeedback('negative')" title="Wrong suggestion">
                    👎
                </button>
                <button class="feedback-btn delete" onclick="deleteBubble()" title="Ignore this error">
                    🗑️
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">Provide Correct Version</div>
            <div class="modal-body">
                <p>You indicated this suggestion is wrong. What should it be instead?</p>
                <div style="margin: 12px 0;">
                    <strong>Original:</strong> <span id="modalOriginal"></span><br>
                    <strong>AI Suggestion:</strong> <span id="modalSuggestion"></span>
                </div>
                <input type="text" class="modal-input" id="modalCorrection" placeholder="Enter the correct version..." />
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                <button class="modal-btn primary" onclick="submitCorrection()">Submit Feedback</button>
            </div>
        </div>
    </div>
</body>
</html> 